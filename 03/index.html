<html>

<head>
  <style>
    html,
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden !important;
    }
  </style>

  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@latest/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
      }
    }
    </script>

  <script type="module">

    import * as THREE from 'three';
    import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

    const HOT_PINK = 0xff69b4;
    const GRASS_GREEN = 0x7cfc00;
    const YELLOW = 0xffff00;

    var renderer, controls, scene, camera;

    window.onload = function () {

      // Three.js code goes here
      scene = new THREE.Scene();
      var allMeshes = [];

      // setup the camera
      var fov = 75;
      var ratio = window.innerWidth / window.innerHeight;
      var zNear = 1;
      var zFar = 10000;
      camera = new THREE.PerspectiveCamera(fov, ratio, zNear, zFar);
      camera.position.set(0, 0, 100);

      // create renderer and setup the canvas
      renderer = new THREE.WebGLRenderer({antialias: true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      function addMesh(mesh) {
        scene.add(mesh);
        allMeshes.push(mesh);
      }

      function handleNonShiftClick(coords) {
        // update cube position
        controls.enabled = true;
        torusKnot.position.set(coords.x, coords.y, coords.z);
      }

      function handleShiftClick(coords) {
        controls.enabled = false;
        var geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
        var material = new THREE.MeshStandardMaterial({color: HOT_PINK, wireframe: isWireframeMode});
        var torusKnot = new THREE.Mesh(geometry, material);
        torusKnot.position.set(coords.x, coords.y, coords.z);
        addMesh(torusKnot);
        lastTorus = torusKnot;
      }

      function castMouseClick(e) {
        var pixel_coords = new THREE.Vector2(e.clientX, e.clientY);

        var vp_coords = new THREE.Vector2(
          (pixel_coords.x / window.innerWidth) * 2 - 1,  //X
          -(pixel_coords.y / window.innerHeight) * 2 + 1) // Y

        var vp_coords_near = new THREE.Vector3(vp_coords.x, vp_coords.y, 0);


        var raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(vp_coords_near, camera);
        var intersects = raycaster.intersectObject(invisible_plane);

        return intersects[0]?.point;
      }

      window.onkeydown = function (e) {
        if (e.key.toLowerCase() === "w") {isWireframeMode = !isWireframeMode};
        allMeshes.forEach(mesh => {
          if (mesh.material) {
            mesh.material.wireframe = isWireframeMode;
          }
        });
      }

      renderer.domElement.onmousedown = function (e) {
        mouseIsDown = true;
        const clickCoords = castMouseClick(e);

        if (e.shiftKey) {
          handleShiftClick(clickCoords);
        } else {
          handleNonShiftClick(clickCoords);
        }

      };

      renderer.domElement.onmousemove = function (e) {
        if (mouseIsDown && e.shiftKey) {
          const delta = e.movementY / 20;
          lastTorus.scale.set(lastTorus.scale.x + delta, lastTorus.scale.y + delta, lastTorus.scale.z + delta);
          if (lastTorus.scale.x < 0) {
            lastTorus.material.color.set(GRASS_GREEN);
          } else {
            lastTorus.material.color.set(HOT_PINK);
          }
        }
      }

      renderer.domElement.onmouseup = function (e) {
        mouseIsDown = false;
        controls.enabled = true;
        lastTorusScale = 1; // set this back to 1
      }

      // setup lights
      var ambientLight = new THREE.AmbientLight();
      scene.add(ambientLight);

      var light = new THREE.DirectionalLight(0xffffff, 5.0);
      light.position.set(10, 100, 10);
      scene.add(light);

      // configure cube
      /*
      var geometry = new THREE.BoxGeometry(20, 20, 20);
      var material = new THREE.MeshStandardMaterial({color: 0xffffff, wireframe: true});
      var cube = new THREE.Mesh(geometry, material);
      */

      var geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
      // var material = new THREE.MeshBasicMaterial({color: 0xffff00});
      // var material = new THREE.MeshStandardMaterial({color: 0xffffff, wireframe: true}); // wireframe
      var material = new THREE.MeshStandardMaterial({color: YELLOW});
      var torusKnot = new THREE.Mesh(geometry, material);

      addMesh(torusKnot);

      // global state
      var lastTorus = null;
      var lastTorusScale = 1;
      var mouseIsDown = false;
      var isWireframeMode = false;

      //
      // The invisible plane
      //
      geometry = new THREE.PlaneGeometry(10000, 10000);
      material = new THREE.MeshBasicMaterial({
        visible: false
      });

      var invisible_plane = new THREE.Mesh(geometry, material);

      scene.add(invisible_plane);

      // interaction
      controls = new OrbitControls(camera, renderer.domElement);

      // call animation/rendering loop
      animate();

    };

    function animate() {

      requestAnimationFrame(animate);

      // and here..
      controls.update();
      renderer.render(scene, camera);

    };
  </script>
</head>

<body></body>

</html>
